<!-- omit in toc -->
# Grep Office

![イメージ図](images/kv.png)

指定ディレクトリより下層に存在するファイルに対して、指定された文字列で Grep 検索を行うツールです。  
プレーンテキストファイルに加えて、Word 、 Excel 、 PowerPoint のファイルの検索にも対応しているのが特徴です。

試作段階のため、対応済みの環境やファイルであっても実行に不備がある可能性があります。ご容赦ください。  
不具合などあった場合はご連絡いただけると大変ありがたいです。

<!-- omit in toc -->
## 目次

- [1. 対応ファイル](#1-対応ファイル)
  - [1.1. 対応済みのファイル](#11-対応済みのファイル)
  - [1.2. 未対応のファイル](#12-未対応のファイル)
- [2. 動作環境](#2-動作環境)
- [3. 環境構築](#3-環境構築)
- [4. 使い方](#4-使い方)
  - [4.1. bat ファイルから実行する場合](#41-bat-ファイルから実行する場合)
  - [4.2. CLI から実行する場合](#42-cli-から実行する場合)
- [5. 補足・便利な使い方](#5-補足便利な使い方)
  - [5.1. 行・文字番号の見方](#51-行文字番号の見方)
  - [5.2. 正規表現や検索ファイル・除外ファイルの設定](#52-正規表現や検索ファイル除外ファイルの設定)
  - [5.3. bat ファイルをショートカットから実行](#53-bat-ファイルをショートカットから実行)
- [6. 留意点](#6-留意点)
  - [6.1. 【⚠️重要】検索するディレクトリはなるべく深い階層を設定する](#61-️重要検索するディレクトリはなるべく深い階層を設定する)
  - [6.2. 正規表現検索を Word と PowerPoint のファイルへ実行する場合の仕様について](#62-正規表現検索を-word-と-powerpoint-のファイルへ実行する場合の仕様について)
  - [6.3. bat ファイルを終了する際の出力について](#63-bat-ファイルを終了する際の出力について)
- [7. ライセンス](#7-ライセンス)
- [8. 参考サイト様](#8-参考サイト様)

## 1. 対応ファイル

### 1.1. 対応済みのファイル

- プレーンテキストファイル（文字コードが UTF-8 のみ）
- Word ファイル（拡張子が `.docx` のみ）
- Excel ファイル（拡張子が `.xlsx` のみ）
- Power Point ファイル（拡張子が `.pptx` のみ）

※ Excel ファイルの場合、セルに直接記述されたテキストのみが取得できます。関数の出力結果やシェイプ中の文字は取得できません。

### 1.2. 未対応のファイル

- 文字コードが UTF-8 以外のプレーンテキストファイル（今後対応予定）
- PDF ファイル（今後対応予定）
- 拡張子に `x` が付かない古い Office 系ファイル（`.xls` , `.ppt` , `.doc`）
  - 検索の際に利用している xml ファイルの仕様が違うらしいため。
- 隠しファイルや隠しディレクトリ配下の検索
  - モジュールのオプション指定で簡単に対応できそうですが、不要そうなので現在は未対応。今後対応させるかも。

## 2. 動作環境

- 動作確認済みの環境
  - Windows 10, 11
  - WSL2（Ubuntu）
  - macOS Monterey
- ソフトウェア
  - Python 3.5 以上（glob モジュールのオプション指定に必要なため、3.5 以上を要件としています）

特殊な実装は特に行っていないので、たいていの環境で動くと思います。

コーディングと動作検証は Windows 11 及び WSL2（Ubuntu）環境上で行っています。  
MacOS は簡単な動作確認のみ行っています。

## 3. 環境構築

動作環境の要件を満たしている PC へ `Code > Download ZIP` からダウンロードして、好みのディレクトリに展開してください。  
Python そのものの構築手順はもう少し詳しく準備予定。

ツールを PC から削除したい場合は、展開したディレクトリを削除してください。

## 4. 使い方

### 4.1. bat ファイルから実行する場合

実行が手軽に行えるように実行用の bat ファイルを準備しています。  
Windows 環境の場合はこちらがオススメです。

1. 展開したディレクトリ配下の `Run-GrepOffice.bat` を起動する。
   1. 初回起動時のみ警告が出ると思いますので許可してください。
2. 画面の指示に従って、検索対象のディレクトリパスを入力して `Enter` キーで送信する。
   1. 入力の際はコピペでも OK です。次項の検索条件も同様。ディレクトリパスの指定はエクスプローラーのアドレスバーからコピペしてくるのがオススメです。
   2. **⚠️ ディレクトリパスはなるべく深い階層を指定してください。** 詳細は [6. 留意点 > 6.1. 【⚠️重要】検索するディレクトリはなるべく深い階層を設定する](#61-【⚠️重要】検索するディレクトリはなるべく深い階層を設定する) をご参照ください。
3. 画面の指示に従って、検索条件とする文字列を入力して `Enter` キーで送信する。
4. 検索条件の一覧を確認したら `Enter` キーを押す。
5. 検索が開始され、検索結果が下記のイメージで表示される。

    ```text
    ▼ 検索結果
    ----------------------------------------------------------

    C:\Users\aaa\bbb\テキストファイル.txt (3, 1) : さしすせそ
    C:\Users\aaa\bbb\エクセルファイル.xlsx (3, 1) : さしすせそ
    C:\Users\aaa\bbb\ccc\パワポファイル.pptx (2, 1) : さしすせそたちつてとあいうえお

    ----------------------------------------------------------
    3 件ヒットしました。

    Grep Office を終了します。
    ```

基本的な使い方は以上です。

終了する際は画面の指示に従ってください。  
ウィンドウを直接閉じても OK です。

### 4.2. CLI から実行する場合

CLI から Python を直接実行しても OK です。  
WSL2 や MacOS などを利用している方はこちらでご利用ください。

1. 展開したディレクトリを PowerShell や Terminal などで開く。
2. `python3 GrepOffice.py` を実行する。
3. 以降の手順は bat ファイルでの手順と同様です。

## 5. 補足・便利な使い方

### 5.1. 行・文字番号の見方

検索結果に表示される `(X, Y)` は、そのファイルの中でマッチした行（もしくはスライド）と文字の位置を表しています。  
ファイル形式によって内部構造が違うため統一はできていませんが、確認する際の目安には使えると思います。

- プレーンテキストの場合
  - X: ○行目
  - Y: ○文字目
- Word ファイルの場合
  - X: 行やシェイプ、表ごとに上から順に並べた状態での○行目
  - Y: X の行ごとの○文字目
- Excel ファイルの場合
  - X: 読み込めたテキストをセルごとに行として並べた状態での○行目（改善の余地あり。。）
  - Y: ○文字目
- Power Point ファイルの場合
  - X: スライド○枚目
  - Y: スライドごとの○文字目

### 5.2. 正規表現や検索ファイル・除外ファイルの設定

ディレクトリ直下に存在する `setup.py` を編集することで、以下のような設定が行えます。

- 正規表現を使用して検索する
  - デフォルトは使用しません。
- 検索を限定したいファイル名を指定する
  - デフォルトは指定なしです。
- 検索から除外したいファイル名を設定する
  - デフォルトは `.exe` 等いくつかのファイルを設定済みです。

詳しくは `setup.py` のコメントを参考に設定を行ってください。  
除外ファイルのデフォルト値は [サクラエディタ](https://sakura-editor.github.io/) の初期設定値から引用させていただいています。

### 5.3. bat ファイルをショートカットから実行

bat ファイルはショートカットからの実行も可能です。  
ショートカットを作成して、デスクトップやスタートメニュー、タスクバーなど好きな場所に配置すると簡単に実行できて便利です。

参考: [【Windows10】バッチファイルをタスクバーにピン留めする方法 – Plane Note](https://note.z0i.net/2020/09/pin-batch-file.html)

## 6. 留意点

### 6.1. 【⚠️重要】検索するディレクトリはなるべく深い階層を設定する

このツールは、指定ディレクトリ配下に存在する展開可能なファイルを順番に開いて検索するという処理を繰り返す仕様です。

ファイルサイズやファイル数などでの制限は現行だと特に設けていないため、  
**指定した階層が浅すぎると PC や検索先のサーバー等に負荷をかけてしまう可能性があります。**

そのため、検索対象にするディレクトリはなるべく深い階層を指定するようにしてください。

### 6.2. 正規表現検索を Word と PowerPoint のファイルへ実行する場合の仕様について

Word と PowerPoint のファイルに対して正規表現での検索を使用する場合、行頭 `^` や行末 `$` の指定が正しく検知できない可能性があります。  
これらのファイルの場合は読み込んだ文字列を結合してから検索するという仕様上、ソースのテキストの行頭や行末が行中になってしまうことがあるためです。

そのためこれらの正規表現を用いる際はご留意ください。

### 6.3. bat ファイルを終了する際の出力について

bat ファイルでツールを起動中に `Ctrl + C` を送信して終了する際、 `Terminate batch job (Y/N)?` （訳: バッチ ジョブを終了しますか？）とメッセージが出力されます。  
[これは cmd.exe の仕様によるものだそう](https://mattn.kaoriya.net/software/windows/20120920154016.htm) で、動作には特に影響ありません。

表示された場合は `N` を入力して送信するか、直接ウィンドウを閉じて OK です。

## 7. ライセンス

このアプリケーションは MIT ライセンスの下でリリースされています。  
ライセンス全文はディレクトリ直下の `LICENSE` ファイルをご確認ください。

## 8. 参考サイト様

主に以下のサイト様の情報を参考にさせていただきました🙇‍♂️  
ソースコードのコメント内でも引用させていただいております。

- [Windows10 - ExcelやWord内の写真を画像として取り出し保存する方法 - Win10ラボ](https://win10labo.info/win10-excel-photo/)
- [PythonでExcelファイルを操作する!(1) /実はzip圧縮ファイルだって知ってました？│YUUKOU's 経験値](https://yuukou-exp.plus/handle-xlsx-with-python-intro/)
- [Pythonを使ってzipファイルからファイルを取り出す - Qiita](https://qiita.com/mriho/items/f82c66e7a232b6b37206)
- [パワーポイント内のテキストをgrepする - Qiita](https://qiita.com/kaityo256/items/2977d53e70bbffd4d601)
- [PythonでのXMLファイル操作例 - Qiita](https://qiita.com/sino20023/items/0314438d397240e56576)
- [基本的な正規表現一覧 | murashun.jp](https://murashun.jp/article/programming/regular-expression.html)
